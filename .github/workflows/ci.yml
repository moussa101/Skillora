name: CI — Tests & Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────
  # Backend — Lint, Type-check, Unit & E2E tests
  # ─────────────────────────────────────────────
  backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Validate Prisma schema
        run: npx prisma validate

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Lint
        run: npx eslint "{src,test}/**/*.ts"

      - name: Type-check
        run: npx tsc --noEmit

      - name: Unit tests
        run: npx jest --passWithNoTests --forceExit --ci

      - name: E2E tests
        run: npx jest --config ./test/jest-e2e.json --passWithNoTests --forceExit --ci

      - name: Build
        run: npm run build

  # ─────────────────────────────────────────────
  # Frontend — Lint, Type-check, Build
  # ─────────────────────────────────────────────
  frontend:
    name: Frontend Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npx eslint .

      - name: Type-check
        run: npx tsc --noEmit

      - name: Build
        env:
          NEXT_PUBLIC_API_URL: https://backend-production-e2f3.up.railway.app
        run: npm run build

  # ─────────────────────────────────────────────
  # ML Service — Lint, Pytest
  # ─────────────────────────────────────────────
  ml-service:
    name: ML Service Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ml_service

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: ml_service/requirements.txt

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic1

      - name: Install CPU-only PyTorch
        run: pip install torch==2.2.0+cpu --extra-index-url https://download.pytorch.org/whl/cpu

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install test dependencies
        run: pip install pytest httpx

      - name: Download spaCy model
        run: python -m spacy download en_core_web_sm

      - name: Syntax check
        run: python -m py_compile main.py && python -m py_compile analyzer.py && python -m py_compile ats_scorer.py

      - name: Run tests
        run: python -m pytest tests/ -v --tb=short

  # ─────────────────────────────────────────────
  # Docker builds (verify Dockerfiles are valid)
  # ─────────────────────────────────────────────
  docker:
    name: Docker Build Check
    runs-on: ubuntu-latest
    # Only run on pushes to main, not on every PR (saves CI minutes)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [backend, frontend, ml-service]

    steps:
      - uses: actions/checkout@v4

      - name: Build backend image
        run: docker build -t skillora-backend ./backend

      - name: Build frontend image
        run: docker build --build-arg NEXT_PUBLIC_API_URL=https://backend-production-e2f3.up.railway.app -t skillora-frontend ./frontend

      - name: Build ML service image
        run: docker build -t skillora-ml ./ml_service
