// Prisma schema for Skillora (AI Resume Analyzer)
// User, Resume, Analysis, and Organization models

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  CANDIDATE
  RECRUITER
  ADMIN
}

enum UserTier {
  GUEST
  PRO
  RECRUITER
}

enum SubscriptionStatus {
  NONE
  ACTIVE
  CANCELLED
  PAST_DUE
}

enum AuthProvider {
  EMAIL
  GITHUB
  GOOGLE
  APPLE
}

// ============================================
// MODELS
// ============================================

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String?  // Optional for OAuth users
  name      String?
  image     String?  // Profile picture from OAuth
  role      UserRole @default(CANDIDATE)
  tier      UserTier @default(GUEST)

  // Email verification
  emailVerified Boolean @default(false)

  // OAuth fields
  provider   AuthProvider @default(EMAIL)
  providerId String?      // ID from OAuth provider

  // Subscription (Stripe prep)
  stripeCustomerId    String?
  subscriptionStatus  SubscriptionStatus @default(NONE)
  subscriptionEndDate DateTime?

  // Usage tracking
  analysesThisMonth Int      @default(0)
  analysesResetDate DateTime @default(now())

  // Organization (for Recruiter tier)
  organizationId Int?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  resumes Resume[]

  @@index([email])
  @@index([providerId])
}

model Organization {
  id           Int      @id @default(autoincrement())
  name         String
  billingEmail String
  stripeCustomerId String?
  apiKey       String   @unique @default(uuid())

  members   User[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Resume {
  id         Int        @id @default(autoincrement())
  userId     Int
  filePath   String
  fileName   String
  fileSize   Int
  parsedText String?    @db.Text
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  analyses Analysis[]

  @@index([userId])
}

model Analysis {
  id            Int      @id @default(autoincrement())
  resumeId      Int
  jobDescText   String   @db.Text
  matchScore    Float
  skillsFound   String[]
  missingSkills String[]
  feedback      Json?
  createdAt     DateTime @default(now())

  resume Resume @relation(fields: [resumeId], references: [id], onDelete: Cascade)

  @@index([resumeId])
}

// ============================================
// VERIFICATION CODES
// ============================================

enum VerificationCodeType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

model VerificationCode {
  id        Int                  @id @default(autoincrement())
  email     String
  code      String
  type      VerificationCodeType
  expiresAt DateTime
  used      Boolean              @default(false)
  createdAt DateTime             @default(now())

  @@index([email, code, type])
}
